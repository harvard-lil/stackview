/*!
 Simple JavaScript Templating originally by John Resig:
 http://ejohn.org/blog/javascript-micro-templating/
 Modified by Rick Strahl:
 http://west-wind.com/weblog/posts/2008/Oct/13/Client-Templating-with-jQuery
 MIT Licensed
*/
(function(){var b={};this.tmpl=function a(e,d){var c=!/\W/.test(e)?b[e]=b[e]||a(document.getElementById(e).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+e.replace(/[\r\t\n]/g," ").replace(/'(?=[^%]*%>)/g,"\t").split("'").join("\\'").split("\t").join("'").replace(/<%=(.+?)%>/g,"',$1,'").split("<%").join("');").split("%>").join("p.push('")+"');}return p.join('');");return d?c(d):c}})();
/*!
	Stack View - The jQuery virtual stack plugin
	by The Harvard Library Innovation Lab
	
	Dual licensed under MIT and GPL.
*/
(function(g,f,a,h){var d,e="stackView",c,b={};d={init:"stackview.init",item_added:"stackview.itemadded",item_removed:"stackview.itemremoved",page_load:"stackview.pageload"};b.translate=function(n,m,j,k,p){var i=j-m,l=p-k,o=(n-m)/(i);return k+o*l};b.get_heat=function(i){return i===100?10:Math.floor(i/10)+1};b.get_height=function(k,l){var n=k.options,j=parseInt(l.measurement_height_numeric,10),m=n.min_item_height,i=n.max_item_height;if(isNaN(j)){j=m}j=Math.min(Math.max(j,m),i);j=b.translate(j,n.min_item_height,n.max_item_height,n.min_height_percentage,n.max_height_percentage);return j+"%"};b.get_thickness=function(k,l){var n=parseInt(l.measurement_page_numeric,10),m=k.options.min_pages,j=k.options.max_pages,i=k.options.page_multiple;if(isNaN(n)){n=m}n=Math.min(Math.max(n,m),j)*i;return n+"px"};b.normalize_link=function(i){return i.title_link_friendly?"../shelflife/book/"+i.title_link_friendly+"/"+i.id:i.link};b.get_author=function(j){var i=j.creator&&j.creator.length?j.creator[0]:"";if(/^([^,]*)/.test(i)){i=i.match(/^[^,]*/)}return i};b.normalize_item=function(i,j){return{heat:b.get_heat(j.shelfrank),book_height:b.get_height(i,j),book_thickness:b.get_thickness(i,j),link:b.normalize_link(j),title:j.title,author:b.get_author(j),year:j.pub_date}};b.render_items=function(i,m,j){var k=j?"before":"append",l=j?j:i.$element.find(i.options.selectors.item_list);g.each(m,function(o,p){var n=g(tmpl(c.templates.book,b.normalize_item(i,p)));n.data("stackviewItem",p);l[k](n)});if(j){j.remove()}};b.calculate_params=function(i){var j=i.options,k;k={start:i.page*i.options.items_per_page,limit:i.options.items_per_page,search_type:i.options.search_type,query:i.options.query};if(k.search_type==="loc_sort_order"){k.start=0;if(i.page===0){i.loc={low:j.id-Math.floor(j.items_per_page/2),high:j.id+Math.floor(j.items_per_page/2)};k.query=["[",i.loc.low,"%20TO%20",i.loc.high,"]"].join("")}else{if(i.direction==="down"){k.query=["[",i.loc.high+1,"%20TO%20",i.loc.high+j.items_per_page+1,"]"].join("");i.loc.high=i.loc.high+j.items_per_page+1}else{if(i.direction==="up"){k.query=["[",i.loc.low-j.items_per_page-1,"%20TO%20",i.loc.low-1,"]"].join("");i.loc.low=i.loc.low-j.items_per_page-1}}}}return k};b.fetch_page=function(j,m){var l=b.calculate_params(j),i=g.param(l),k;j.page++;k=f.stackCache.get(j.options.url+i);if(k){m(k)}else{g.ajax({url:j.options.url,data:i,dataType:j.options.jsonp?"jsonp":"json",success:function(n){f.stackCache.set(j.options.url+l,n,j.options.cache_ttl);m(n)}})}};c=function(j,i){this.element=j;this.$element=g(j);this.options=g.extend({},c.defaults,i);this.page=0;this.finished={up:false,down:false};this.loc={low:null,high:null};this.direction="down";this.init()};g.extend(c,{defaults:{url:"basic.json",data:"",jsonp:false,items_per_page:10,page_multiple:0.2,height_multiple:12.5,search_type:"keyword",query:"",ribbon:"Stack View",id:null,min_pages:200,max_pages:540,min_item_height:20,max_item_height:39,min_height_percentage:59,max_height_percentage:100,cache_ttl:60,selectors:{item:".stack-item",item_list:".stack-items",ribbon:".ribbon"}}});g.extend(true,c.prototype,{init:function(){var i=this;this.$element.html(tmpl(c.templates.scaffold,{ribbon:this.options.ribbon})).addClass("stackview").bind(d.page_load,function(){i.zIndex()});this.$element.data("stackviewObject",this);this.$element.trigger(d.init);this.next_page()},next_page:function(){var i=g(tmpl(c.templates.placeholder,{})),k=this,j=this.options;if(this.finished.down){return}this.direction="down";if(j.data){b.render_items(this,j.data.docs?j.data.docs:j.data);this.finished.down=true;this.$element.trigger(d.page_load,[j.data])}else{if(j.url){this.$element.find(j.selectors.item_list).append(i);b.fetch_page(this,function(l){b.render_items(k,l.docs,i);if(parseInt(l.start,10)===-1){k.finished.down=true}k.$element.trigger(d.page_load,[l])})}}},prev_page:function(){var i=g(tmpl(c.templates.placeholder,{})),k=this.options,j=this,l=j.$element.find(k.selectors.item).first();if(k.search_type!=="loc_sort_order"||this.finished.up){return}this.direction="up";this.$element.find(k.selectors.item_list).prepend(i);b.fetch_page(this,function(n){var m=l.position().top;b.render_items(j,n.docs,i);if(j.page>1){j.$element.find(k.selectors.item_list).animate({scrollTop:"+="+(l.position().top-m)},0)}if(parseInt(n.start,10)===-1){j.finished.up=true}j.$element.trigger(d.page_load,[n])})},add:function(){var n=this.$element.find(this.options.selectors.item),j,k,l,m,i;if(typeof(arguments[0])==="number"){j=arguments[0];k=arguments[1]}else{j=n.length;k=arguments[0]}if(j>n.length||j<0){return}else{if(j===n.length){m=n.last();l="after"}else{m=n.eq(j);l="before"}}i=g(tmpl(c.templates.book,b.normalize_item(this,k)));i.data("stackviewItem",k);m[l](i);this.zIndex();this.$element.trigger(d.item_added)},remove:function(i){var m=this.$element.find(this.options.selectors.item),k,l,j;if(typeof(i)==="number"){k=m.eq(i)}else{if(i.nodeType||i.jquery){k=g(i)}else{m.each(function(o,p){var n=g(p);if(n.data("stackviewItem")===i){k=n;return false}})}}if(k==null||!k.length){return}k.detach();l=k.data("stackviewItem");this.$element.trigger(d.item_removed,[l]);return k},getData:function(){var i=[];this.$element.find(this.options.selectors.item).each(function(){i.push(g(this).data("stackviewItem"))});return i},zIndex:function(j){var n=this.$element.find(this.options.selectors.item),l=n.length,k=0,m=j?0:n.length-1;while(k<l){n.eq(k).css("z-index",m);m=m+(j?1:-1);k++}}});g.fn[e]=function(k){var i,j=Array.prototype.slice.call(arguments,1);this.each(function(m,o){var l=g(o),p=l.data("stackviewObject");if(!p){new c(o,k)}else{if(p[k]){var n=p[k].apply(p,j);if(i===h&&n!==h){i=n}}}});return i===h?this:i};f.StackView=c})(jQuery,window,document);(function(c,d){var a=c(document),b;c.extend(StackView.defaults,{infiniteScrollDistance:100});b=function(h){var i=c(h.target),e=i.data("stackviewObject"),g=e.options,l,g,j,f,k;l=i.find(g.selectors.item_list);j=l.find(g.selectors.item).last().position().top;j+=l.scrollTop();f=j-i.height()-g.infiniteScrollDistance;k=function(){if(g.search_type==="loc_sort_order"&&l.scrollTop()<=g.infiniteScrollDistance){l.unbind("scroll.stackview");i.stackView("prev_page")}else{if(l.scrollTop()>=f){l.unbind("scroll.stackview");i.stackView("next_page")}}};l.bind("scroll.stackview",k);k()};a.delegate(".stackview","stackview.pageload",b)})(jQuery);(function(c,d){var b=c(document),a=window.StackView;c.extend(true,a.defaults,{transitionDuration:200,navigationPercent:80,selectors:{downstream:".downstream",upstream:".upstream",num_items:".num-found span"}});b.delegate(".stackview","stackview.init",function(f){var g=c(f.target),e=g.data("stackviewObject"),i=g.find(e.options.selectors.item_list),h=g.height()*e.options.navigationPercent/100;e.num_found_delta=0;g.prepend(tmpl(a.templates.navigation,{empty:e.options.search_type==="loc_sort_order"}));g.delegate(e.options.selectors.downstream,"click",function(){i.animate({scrollTop:"+="+h},e.options.transitionDuration);return false}).delegate(e.options.selectors.upstream,"click",function(){i.animate({scrollTop:"-="+h},e.options.transitionDuration);return false})}).delegate(".stackview","stackview.pageload",function(h,i){var j=c(h.target),e=j.data("stackviewObject"),g=i.num_found?parseInt(i.num_found,10):i.length,f;e.num_found=g;f=g+e.num_found_delta;j.find(e.options.selectors.num_items).text(f)}).delegate(".stackview","stackview.itemadded stackview.itemremoved",function(g){var h=c(g.target),e=h.data("stackviewObject"),i=h.find(e.options.selectors.item),f;e.num_found_delta+=(g.namespace==="itemadded"?1:-1);f=e.num_found+e.num_found_delta;h.find(e.options.selectors.num_items).text(f)})})(jQuery);window.stackCache=(function(d,f){var b={},e=d.JSON&&(function(){try{return("localStorage" in d)&&d.localStorage!==null}catch(h){return false}})();return{set:g,get:c,remove:a};function g(j,k,h){var i=h&&new Date(+new Date()+h*1000),m={expires:+i,value:k};if(e){try{localStorage[j]=JSON.stringify(m)}catch(l){return l}}else{b[j]=m}}function c(h){var i,j;if(e){i=localStorage[h];if(i){i=JSON.parse(i)}}else{i=b[h]}if(i){if(i.expires&&i.expires<+new Date()){a(h)}else{j=i.value}}return j}function a(h){if(e){localStorage.removeItem(h)}else{delete b[h]}}})(window);(function(a){StackView.templates={scaffold:'			<div class="ribbon"><%= ribbon %></div>			<ul class="stack-items" />',navigation:'			<div class="stack-navigation<%= empty ? " empty" : ""%>">				<div class="upstream">Up</div>				<div class="num-found">					<span></span><br />items				</div>				<div class="downstream">Down</div>			</div>',book:'			<li class="stack-item stack-book heat<%= heat %>" style="width:<%= book_height %>; height:<%= book_thickness %>;">				<a href="<%= link %>" target="_newtab">					<span class="spine-text">						<span class="spine-title"><%= title %></span>						<span class="spine-author"><%= author %></span>					</span>					<span class="spine-year"><%= year %></span>					<span class="stack-pages" />					<span class="stack-cover" />				</a>			</li>',placeholder:'<li class="stackview-placeholder"></li>'}})();